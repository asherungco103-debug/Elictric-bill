<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Electric Bill Calculator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* BASE STYLES */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    :root {
      --bg-dark: #1F1F1F;
      /* Darker background from images */
      --bg-medium: #2C2C2C;
      /* Card background */
      --accent-teal: #4db8c4;
      --accent-orange: #FF6B00;
      /* New accent color for highlights/username */
      --text-light: #ffffff;
      --text-muted: #999999;
      --input-bg: #404040;
      /* Darker input background */
      --max-width-mobile: 400px;
    }

    body {
      background: var(--bg-dark);
      min-height: 100vh;
      padding-top: 20px;
      padding-bottom: 80px;
      color: var(--text-light);
    }

    .container {
      max-width: var(--max-width-mobile);
      margin: 0 auto;
      min-height: calc(100vh - 40px);
      position: relative;
      padding: 0 15px;
    }

    /* Mobile screen padding adjustment for content */
    .screen {
      background: var(--bg-dark);
      padding: 0px 15px 30px;
      min-height: 100%;
      display: none;
      flex-direction: column;
    }

    .page.active {
      display: flex;
    }

    /* COMPONENTS */
    .btn {
      background: var(--accent-teal);
      color: var(--text-light);
      border: none;
      padding: 14px 60px;
      border-radius: 30px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 0;
      width: 100%;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(77, 184, 196, 0.3);
      transition: all 0.3s;
    }

    .btn:hover {
      background: #3da5b0;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-dark);
      border: 1px solid var(--accent-teal);
      color: var(--accent-teal);
      box-shadow: none;
    }

    .input-group {
      width: 100%;
      margin-bottom: 20px;
    }

    .input-field {
      width: 100%;
      background: var(--input-bg);
      color: var(--text-light);
      border: none;
      padding: 14px 20px;
      border-radius: 25px;
      font-size: 15px;
      outline: none;
    }

    /* WELCOME & AUTH - keeping original design for these pages */
    .welcome-screen {
      justify-content: center;
      align-items: center;
      padding-top: 100px;
    }

    .logo-container {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 50px;
    }

    /* Keeping logo-title styles as they are used in the desktop header */
    .logo-title {
      color: var(--text-light);
      font-size: 24px;
      text-align: center;
    }

    .logo-title span {
      display: block;
      font-size: 32px;
      font-weight: 600;
    }

    .auth-screen {
      padding-top: 50px;
    }

    .auth-header {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 40px;
    }

    .auth-icon-container {
      width: 80px;
      height: 80px;
      background: var(--accent-teal);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      font-size: 40px;
      color: var(--bg-dark);
    }

    .auth-title {
      color: var(--text-light);
      font-size: 24px;
      font-weight: 600;
    }

    /* APP UI */
    /* Updated header for the main app pages (no longer centered) */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 30px 0;
      width: 100%;
    }

    .header h3 {
      color: var(--text-light);
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .app-card,
    .usage-card {
      background: var(--bg-medium);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    /* --- HOME/CALCULATOR (Energy Usage Card Update) --- */
    .usage-card {
      background: #333333;
      /* Darker gradient look */
      background: linear-gradient(145deg, #333333, #1f1f1f);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      margin-top: 20px;
      /* Space from new top area */
    }

    .kwh-value {
      color: var(--accent-orange);
      font-size: 40px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .kwh-value span:last-child {
      color: var(--text-muted) !important;
      font-size: 20px !important;
    }

    /* Power Icon Styling for Energy Usage Card */
    .power-icon-container {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 60px;
      color: rgba(255, 255, 255, 0.1);
      transform: rotate(-15deg);
    }

    /* --- APPLIANCE GRID (Matching Home Image) --- */
    .appliance-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .appliance-card {
      background: var(--bg-medium);
      border-radius: 15px;
      padding: 15px;
      cursor: pointer;
      min-height: 120px;
      /* Ensure better click target */
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
    }

    .appliance-icon {
      font-size: 30px;
      margin-bottom: 10px;
      /* Added for image container */
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-radius: 5px;
    }

    .appliance-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .appliance-name {
      color: var(--text-light);
      font-weight: 600;
      font-size: 16px;
    }

    .appliance-power {
      color: #888;
      font-size: 12px;
      margin-top: 5px;
    }

    .appliance-dot {
      width: 8px;
      height: 8px;
      background: var(--accent-teal);
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }

    .appliance-menu {
      position: absolute;
      top: 10px;
      right: 10px;
      color: var(--text-muted);
      cursor: pointer;
    }

    /* --- NEW STYLES FOR ADD DEVICE FORM (Now modal content) --- */
    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .delete-btn {
      color: #ff4757;
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.5);
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      z-index: 2;
      /* Ensure it's above the image */
    }

    .image-upload-container {
      border: 1px solid var(--input-bg);
      border-radius: 25px;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      background: var(--input-bg);
    }

    .image-upload-container i {
      color: var(--accent-teal);
    }

    .image-upload-container span {
      color: var(--text-muted);
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* --- HISTORY/BILL HISTORY (Matching Image) --- */
    .chart-header-row {
      display: flex;
      justify-content: space-around;
      background: var(--bg-medium);
      border-radius: 10px;
      padding: 5px 0;
      margin-bottom: 15px;
    }

    .chart-header-button {
      background: var(--bg-dark);
      color: var(--text-light);
      border: none;
      padding: 8px 20px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      margin: 5px;
      min-width: 100px;
      text-align: center;
    }

    .chart-area {
      background: var(--bg-medium);
      border-radius: 15px;
      padding: 20px 10px 0;
      height: 200px;
      /* Taller chart */
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      gap: 8px;
      margin-bottom: 20px;
      position: relative;
      /* For the title */
    }

    .chart-area h3 {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: var(--text-light);
      font-weight: 300;
      font-size: 20px;
      letter-spacing: 2px;
    }

    /* Bar chart styling matching the image */
    .bar-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 12%;
      height: 100%;
      justify-content: flex-end;
    }

    .bar {
      width: 100%;
      background: #ff4757;
      /* Red color from image */
      border-radius: 4px 4px 0 0;
      transition: height 0.5s;
    }

    .bar-label {
      color: var(--text-muted);
      font-size: 10px;
      margin-top: 5px;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      color: var(--text-light);
      text-align: center;
    }

    .history-table th {
      color: var(--text-light);
      text-align: center;
      padding: 10px 0;
      border-bottom: 1px solid #444;
      font-size: 14px;
      background: var(--bg-medium);
      /* Background for header buttons look */
    }

    .history-table td {
      padding: 15px 0;
      border-bottom: 1px solid #444;
      font-size: 14px;
    }

    /* --- PROFILE (Matching Image) --- */
    .profile-header-card {
      background: none;
      border-radius: 0;
      padding: 20px 0;
      margin-bottom: 10px;
    }

    .profile-pic {
      width: 100px;
      height: 100px;
      background: none;
    }

    .profile-pic img {
      border: 3px solid var(--accent-teal);
    }

    .profile-name {
      color: var(--accent-orange);
      font-size: 28px !important;
      margin-top: 5px;
    }

    .edit-pic-btn {
      right: 5px;
      bottom: 5px;
      background: var(--bg-medium);
      color: var(--accent-teal);
      border: 2px solid var(--accent-teal);
    }

    .menu-section-group {
      margin-bottom: 25px;
      border-radius: 15px;
      overflow: hidden;
    }

    .menu-list-section {
      background: var(--bg-medium);
      border-radius: 0;
      padding: 0;
      margin-bottom: 1px;
    }

    .menu-item {
      border-bottom: 1px solid #333;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      /* Added for all menu items */
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-item-icon {
      color: var(--text-light);
    }

    /* Icons match background text color */
    .menu-item-value {
      color: var(--accent-teal);
      font-weight: 500;
    }

    .menu-item-icon-container {
      width: 20px;
      text-align: center;
      margin-right: 15px;
    }

    .profile-pic-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    .profile-pic {
      width: 100px;
      height: 100px;
      background: var(--bg-medium);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      margin: 0 auto 10px;
    }

    .profile-pic img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border: 2px solid var(--accent-teal);
    }

    .profile-pic i {
      font-size: 40px;
      color: var(--text-muted);
    }

    .edit-pic-btn {
      position: absolute;
      right: 150px;
      /* Adjusted for better centering */
      bottom: 15px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
    }

    /* --- MODAL STYLES --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: var(--bg-medium);
      margin: auto;
      padding: 20px;
      border-radius: 15px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h4 {
      color: var(--text-light);
      font-size: 18px;
    }

    .close-btn {
      color: var(--text-muted);
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

    .theme-option {
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .theme-option.active {
      border-color: var(--accent-teal);
      background-color: #383838;
    }

    /* NEW STYLES FOR SELECTION MODAL */
    .selection-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--input-bg);
      border-radius: 10px;
      margin-bottom: 20px;
      background: var(--input-bg);
    }

    .selection-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid #333;
      cursor: pointer;
    }

    .selection-item:last-child {
      border-bottom: none;
    }

    .selection-item-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .selection-item-info span {
      font-size: 14px;
    }

    .selection-item-info strong {
      color: var(--accent-teal);
    }

    .appliance-selection-checkbox {
      /* Basic style for the checkbox input itself */
      width: 18px;
      height: 18px;
    }


    /* BOTTOM NAV (Matching Image) */
    .bottom-nav {
      background: var(--bg-medium);
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.8);
      padding-top: 5px;
      /* Adjust padding for power button */
    }

    .nav-item {
      color: var(--text-muted);
      padding: 10px 0;
    }

    .nav-item.active {
      color: var(--accent-teal);
    }

    .nav-icon {
      font-size: 24px;
      margin-bottom: 0;
    }

    /* Power button in the center */
    .power-btn-container {
      width: 60px;
      height: 60px;
      background: var(--accent-teal);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 4px 15px rgba(77, 184, 196, 0.5);
      cursor: pointer;
    }

    .power-btn-icon {
      color: var(--bg-dark);
      font-size: 28px;
    }

    /* General Top Bar for App Screens (Home and History) */
    .top-app-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      width: 100%;
    }

    .top-app-bar .home-icon,
    .top-app-bar .notification-container {
      font-size: 24px;
      color: var(--text-light);
      cursor: pointer;
    }

    .user-greeting {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-greeting .profile-pic {
      width: 40px;
      height: 40px;
      margin: 0;
    }

    .user-info span {
      display: block;
      font-size: 14px;
      color: var(--text-muted);
    }

    .user-info strong {
      font-size: 18px;
      color: var(--accent-orange);
      font-weight: 600;
    }

    .notification-badge-container {
      position: relative;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 10px;
      height: 10px;
      background: var(--accent-orange);
      border-radius: 50%;
    }

    /* Responsive Fix for Profile Pic Edit Button */
    @media (max-width: 400px) {
      .edit-pic-btn {
        right: calc(50% - 50px - 15px);
        /* Center 100px image, shift right 50px + 15px margin */
      }
    }

    /* RESPONSIVENESS */
    @media (min-width: 768px) {
      body {
        padding-top: 80px;
        padding-bottom: 20px;
      }

      .container {
        max-width: 1000px;
        min-height: auto;
        padding-top: 20px;
        padding-bottom: 20px;
        display: flex;
        gap: 30px;
      }

      .screen {
        width: 100%;
        background: none;
        padding: 0;
      }

      .welcome-screen,
      .auth-screen {
        margin-top: 100px;
        align-items: center;
        justify-content: center;
        padding: 0;
      }

      .auth-screen {
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
      }

      /* Desktop Navigation */
      .desktop-header {
        display: block;
      }

      .bottom-nav {
        display: none !important;
      }

      .top-app-bar {
        display: none;
      }

      /* Hide the mobile top bar */

      /* Profile button in desktop header */
      .desktop-profile-area {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .desktop-profile-pic {
        width: 30px;
        height: 30px;
        background: var(--bg-medium);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      .desktop-profile-pic i {
        font-size: 18px;
        color: var(--text-muted);
      }

      .desktop-profile-pic img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .desktop-profile-info {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .desktop-profile-info span {
        color: var(--text-light);
        font-size: 14px;
      }

      /* Layout adjustments for calculator/energy page */
      #calculator {
        display: grid !important;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      #energy {
        grid-column: 2 / 3;
      }
    }
  </style>
</head>

<body>

  <header id="desktopHeader" class="desktop-header"
    style="display:none; padding: 0 30px; max-width: 1200px; margin: 0 auto; ">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div class="logo-title" style="margin:0;"><span style="font-size: 20px; font-weight: 300;">ELECTRIC
          BILL</span><span
          style="display:block; font-size:12px; font-weight: 300; letter-spacing: 5px; color: var(--text-muted);">CALCULATOR</span>
      </div>
      <div class="desktop-nav-links" style="display:flex; gap: 20px;">

        <a href="#" id="navCalc" data-page="calculator" class="active" onclick="handleNavClick('calculator')"
          style="color:var(--text-light); text-decoration:none;">Home</a>
        <a href="#" id="navHistory" data-page="history" onclick="handleNavClick('history')"
          style="color:var(--text-muted); text-decoration:none;">History</a>
        <a href="#" id="navEnergy" data-page="energy" onclick="handleNavClick('energy')" style="color:var(--text-muted);
                    text-decoration:none;">Energy</a>
      </div>
      <div id="desktopProfileArea" class="desktop-profile-area" style="display:none;">
        <div class="notification-badge-container" onclick="showMsg('Notifications coming soon!')" style="font-size: 18px;
                    color: var(--text-light); cursor: pointer;">
          <i class="fas fa-bell fa-lg"></i>
          <span id="notifBadge" class="notification-badge" style="display:block;">1</span>
        </div>
        <div class="desktop-profile-info" onclick="handleNavClick('profile')">

          <div class="desktop-profile-pic">
            <span id="desktopDefaultAvatarIcon"><i class="fas fa-user"></i></span>
            <img id="desktopProfilePicImg" src="" style="display:none;" />

          </div>
          <span id="desktopProfileName">User</span>

        </div>
      </div>
    </div>
    <hr style="border: none;
            height: 1px; background-color: #333; margin-top: 10px;">
  </header>

  <div class="container">
    <div id="welcome" class="screen page active welcome-screen">
      <div style="flex-grow: 1;
                display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div class="logo-container">
          <img src="logo.png" alt="Electric Bill Calculator Logo"
            style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
        </div>
      </div>
      <div style="width: 100%;">
        <button class="btn" onclick="navigateTo('login')">Login</button>
        <button class="btn btn-secondary" onclick="navigateTo('signup')">Sign up</button>
      </div>
    </div>

    <div id="signup" class="screen page auth-screen">
      <div class="auth-header">
        <div class="auth-icon-container"><i class="fas fa-user-plus"></i></div>

        <div class="auth-title">Create Account</div>
      </div>
      <div class="input-group"><input id="signupUsername" type="text" class="input-field" placeholder="Username"></div>
      <div class="input-group"><input id="signupEmail" type="email" class="input-field" placeholder="Email"></div>
      <div class="input-group"><input id="signupPhone" type="text" class="input-field" placeholder="Phone Number"></div>
      <div class="input-group"><input id="signupPassword" type="password" class="input-field" placeholder="Password">
      </div>
      <button id="signupBtn" class="btn">Register</button>

      <div style="text-align:center; color:var(--text-muted);
                margin-top:20px;">
        Already have an account? <a href="#" onclick="navigateTo('login')" style="color:var(--accent-teal);">Login</a>
      </div>
    </div>

    <div id="login" class="screen page auth-screen">
      <div class="auth-header">
        <div class="auth-icon-container"><i class="fas fa-sign-in-alt"></i></div>

        <div class="auth-title">Welcome Back</div>
      </div>
      <div class="input-group"><input id="loginEmail" type="email" class="input-field" placeholder="Email"></div>
      <div class="input-group"><input id="loginPassword" type="password" class="input-field" placeholder="Password">
      </div>
      <button id="loginBtn" class="btn">Log In</button>
    </div>

    <div id="calculator" class="screen page">
      <div class="top-app-bar">

        <div class="user-greeting">
          <div class="profile-pic">
            <span id="mobileDefaultAvatarIconHome"><i class="fas fa-user"></i></span>
            <img id="mobileProfilePicImgHome" src="" style="display:none;" />

          </div>
          <div class="user-info">
            <span>Hi, </span>
            <strong id="mobileHomeUsername">User</strong> üëã

          </div>
        </div>
        <div class="notification-badge-container" onclick="handleNavClick('profile')">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" style="display:block;
                        background: var(--accent-orange);">1</span>
        </div>
      </div>

      <div class="header" style="padding-top:10px;">
        <h3 style="font-size:20px;">Energy Usage</h3>
        <div style="font-size: 14px;
                    color: var(--accent-teal); cursor:pointer;">More Details ‚Üí</div>
      </div>

      <div class="usage-card">
        <div style="font-size: 14px;
                    color: var(--text-muted); margin-bottom: 8px;">Week 51, 2025</div>
        <div class="kwh-value"><span id="calcDisplayKwh">450</span> <span>KWh</span></div>
        <div class="power-icon-container"><i class="fas fa-bolt"></i></div>
      </div>

      <div class="header" style="padding: 20px 0 15px;">
        <h3 style="font-size:20px;
                    font-weight: normal;">Control your Home</h3>
        <div style="color: var(--text-light);
                    cursor:pointer; font-size:14px;">Rooms <i class="fas fa-chevron-down"></i></div>
      </div>

      <div class="appliance-grid">
        <div class="appliance-card">
          <div class="appliance-menu"><i class="fas fa-ellipsis-v"></i></div>

          <div class="appliance-icon"><i class="fas fa-utensils"></i></div>
          <div>
            <div class="appliance-name">Kitchen</div>
            <div class="appliance-power"><span class="appliance-dot"></span>3 Devices</div>
          </div>

        </div>
        <div class="appliance-card">
          <div class="appliance-menu"><i class="fas fa-ellipsis-v"></i></div>
          <div class="appliance-icon"><i class="fas fa-bed"></i></div>
          <div>

            <div class="appliance-name">Bedroom</div>
            <div class="appliance-power"><span class="appliance-dot"></span>3 Devices</div>
          </div>
        </div>
        <div class="appliance-card">
          <div class="appliance-menu"><i class="fas fa-ellipsis-v"></i></div>
          <div class="appliance-icon"><i class="fas fa-couch"></i></div>
          <div>
            <div class="appliance-name">Living room</div>

            <div class="appliance-power"><span class="appliance-dot"></span>3 Devices</div>
          </div>
        </div>
        <div class="appliance-card">
          <div class="appliance-menu"><i class="fas fa-ellipsis-v"></i></div>

          <div class="appliance-icon"><i class="fas fa-bath"></i></div>
          <div>
            <div class="appliance-name">Bathroom</div>
            <div class="appliance-power"><span class="appliance-dot"></span>3 Devices</div>

          </div>
        </div>
      </div>
    </div>

    <div id="energy" class="screen page">
      <div class="header">
        <h3>DEVICE MANAGER</h3>
      </div>
      <p style="color:var(--text-muted);">Manage your appliances and calculate bill estimates in Pesos.</p>

      <div class="app-card" style="margin-top:20px;">
        <h4 style="color:var(--text-light); margin-bottom:15px;">Bill Calculator (‚Ç±)</h4>
        <div class="input-group">
          <label style="color:var(--text-muted); display:block; margin-bottom:5px;">Connection Type</label>
          <select id="connSelect" class="input-field" onchange="toggleCustomRateInput()" style="border-radius:25px;
appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%20viewBox%3D%220%200%20292.4%20292.4%22%3E%3Cpath%20fill%3D%22%23999999%22%20d%3D%22M287%20120c-3-3-9-3-12%200L146%20249%2018%20120c-3-3-9-3-12%200s-3%209%200%2012l134%20134c3%203%209%203%2012%200l134-134c3-3%203-9%200-12z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 15px center;
background-size: 12px;">
            <option value="residential">Residential (‚Ç±12.00/kWh)</option>
            <option value="commercial">Commercial (‚Ç±16.00/kWh)</option>
            <option value="custom">Custom Rate (‚Ç±/kWh)</option>
          </select>
        </div>
        <div id="customRateGroup" class="input-group" style="display:none; margin-top: -10px;">
          <label style="color:var(--accent-teal); display:block; margin-bottom:5px; font-size:12px;">Enter Rate in
            ‚Ç±/kWh</label>
          <input id="customRateInput" type="number" step="0.01" class="input-field" placeholder="e.g., 14.50">
        </div>

        <div class="input-group">
          <label style="color:var(--text-muted); display:block; margin-bottom:5px;">Appliances to Calculate</label>
          <button id="selectAppliancesBtn" class="btn btn-secondary"
            style="padding: 14px 20px; font-size: 15px; width:100%;" onclick="openModal('selectApplianceModal')">Select
            Appliances for Estimate</button>
          <div id="selectedApplianceSummary" style="color:var(--accent-teal); font-size:12px; margin-top:5px;">0
            appliances selected. Total Wattage: 0W</div>
        </div>

        <div class="input-group">
          <label style="color:var(--text-muted); display:block; margin-bottom:5px;">Daily Usage (Hours)</label>
          <input id="dailyHoursInput" type="number" class="input-field"
            placeholder="Average hours used per day (e.g., 5)">
        </div>

        <button id="calcBtn" class="btn" style="margin-top:10px;">Calculate Bill Estimate</button>
      </div>

      <button onclick="openModal('addApplianceModal')" class="btn btn-secondary"
        style="padding: 10px; font-size: 14px; margin-top: 15px;">+ Add New Device</button>

      <h4 style="color:var(--text-light); margin-top:25px; margin-bottom:15px;">Your Appliances</h4>
      <div id="dynamicApplianceGrid" class="appliance-grid">
      </div>
    </div>

    <div id="history" class="screen page">
      <div class="header">
        <h3>BILL HISTORY</h3>
      </div>
      <div class="chart-header-row">
        <button id="chartBtnYear" class="chart-header-button" onclick="updateChartView('year')">Year</button>
        <button id="chartBtnMonth" class="chart-header-button"
          style="background: var(--accent-teal); color: var(--bg-dark);"
          onclick="updateChartView('month')">Month</button>
        <button id="chartBtnWeek" class="chart-header-button" onclick="updateChartView('week')">Week</button>
      </div>
      <div id="chartArea" class="chart-area">
        <h3>Consumption (KWh)</h3>
      </div>
      <div class="app-card">
        <h4 style="color:var(--text-light); margin-bottom:15px;">Past Bills</h4>
        <table class="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Rate (Kwh)</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr>
              <td>Sept. 2025</td>
              <td>320 / ‚Ç±12.00</td>
              <td>‚Ç±3,840.00</td>
            </tr>
            <tr>
              <td>Oct. 2025</td>
              <td>200 / ‚Ç±12.00</td>
              <td>‚Ç±2,400.00</td>
            </tr>
            <tr>
              <td>Nov. 2025</td>
              <td>240 / ‚Ç±16.00</td>
              <td>‚Ç±3,840.00</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="usage-card" style="margin-top: 20px;">
        <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">Week 51, 2025</div>
        <div class="kwh-value"><span id="calcDisplayKwh2">450</span> <span>KWh</span></div>
        <div class="power-icon-container"><i class="fas fa-bolt"></i></div>
      </div>
    </div>

    <div id="profile" class="screen page">
      <div class="top-app-bar" style="justify-content: flex-start;">
        <div class="top-app-bar .home-icon" onclick="navigateTo('calculator')"><i class="fas fa-home"></i></div>
        <h3 style="margin: 0 auto; padding-right: 24px; font-weight: 300; letter-spacing: 2px;">PROFILE</h3>
        <div class="notification-badge-container" onclick="handleNavClick('profile')">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" style="display:block; background: var(--accent-orange);">1</span>
        </div>
      </div>
      <div class="profile-header-card">
        <div class="profile-pic-container">
          <div class="profile-pic" id="profilePic">
            <span id="defaultAvatarIcon"><i class="fas fa-user"></i></span>
            <img id="profilePicImg" src="" style="display:none;" />
          </div>
          <div class="edit-pic-btn" onclick="document.getElementById('avatarInput').click()">‚úèÔ∏è</div>
        </div>
        <input id="avatarInput" type="file" accept="image/*" style="display:none;">
        <div id="profileName" class="profile-name" style="text-align: center;">Asher</div>
      </div>
      <div class="menu-section-group">
        <div class="menu-list-section">
          <div class="menu-item" onclick="openModal('editProfileModal')">
            <div style="display:flex;
                            align-items:center;"><span class="menu-item-icon-container"><i
                  class="fas fa-clipboard-list"></i></span> Edit profile information</div>
            <div style="font-size:18px; color:var(--text-light);"><i class="fas fa-chevron-right"></i></div>
          </div>
          <div class="menu-item">
            <div style="display:flex;
                            align-items:center;"><span class="menu-item-icon-container"><i
                  class="fas fa-bell"></i></span> Notifications</div>
            <div id="notifStatus" class="menu-item-value" style="color:var(--accent-teal);">ON</div>
          </div>
          <div class="menu-item">
            <div style="display:flex;
                            align-items:center;"><span class="menu-item-icon-container"><i
                  class="fas fa-language"></i></span> Language</div>
            <div class="menu-item-value" style="color:var(--accent-teal);">English</div>
          </div>
        </div>
      </div>
      <div class="menu-section-group">
        <div class="menu-list-section">
          <div class="menu-item" onclick="navigateTo('security')">
            <div style="display:flex;
                            align-items:center;"><span class="menu-item-icon-container"><i
                  class="fas fa-lock"></i></span> Security</div>
            <div style="font-size:18px; color:var(--text-light);"><i class="fas fa-chevron-right"></i></div>
          </div>
          <div class="menu-item" onclick="openModal('themeModal')">
            <div style="display:flex;
                            align-items:center;"><span class="menu-item-icon-container"><i
                  class="fas fa-sun"></i></span> Theme</div>
            <div class="menu-item-value" id="currentTheme">Dark</div>
          </div>
          <div class="menu-item" onclick="navigateTo('helpSupport')">
            <div style="display:flex;
                            align-items:center;"><span class="menu-item-icon-container"><i
                  class="fas fa-info-circle"></i></span> Help & Support</div>
            <div style="font-size:18px;
                            color:var(--text-light);"><i class="fas fa-chevron-right"></i></div>
          </div>
        </div>
      </div>
      <button id="logoutBtn" class="btn btn-secondary"
        style="background: none; border-color: #ff4757; color: #ff4757; margin-top: 20px;">Log out</button>
    </div>

    <div id="security" class="screen page">
      <div class="top-app-bar" style="justify-content: flex-start;">
        <div class="top-app-bar .home-icon" onclick="navigateTo('profile')"><i class="fas fa-chevron-left"></i></div>
        <h3 style="margin: 0 auto; padding-right: 24px; font-weight: 300; letter-spacing: 2px;">SECURITY</h3>
      </div>
      <div class="menu-section-group" style="margin-top: 20px;">
        <div class="menu-list-section">
          <div class="menu-item" onclick="openModal('changePasswordModal')">
            <div style="display:flex; align-items:center;"><span class="menu-item-icon-container"><i
                  class="fas fa-key"></i></span> Change Password</div>
            <div style="font-size:18px; color:var(--text-light);"><i class="fas fa-chevron-right"></i></div>
          </div>
          <div class="menu-item" onclick="showMsg('Two-Factor Authentication coming soon.')">
            <div style="display:flex; align-items:center;"><span class="menu-item-icon-container"><i
                  class="fas fa-user-shield"></i></span> Two-Factor Authentication</div>
            <div class="menu-item-value" style="color:var(--accent-orange);">OFF</div>
          </div>
        </div>
      </div>
    </div>

    <div id="helpSupport" class="screen page">
      <div class="top-app-bar" style="justify-content: flex-start;">
        <div class="top-app-bar .home-icon" onclick="navigateTo('profile')"><i class="fas fa-chevron-left"></i></div>
        <h3 style="margin: 0 auto;
                    padding-right: 24px; font-weight: 300; letter-spacing: 2px;">HELP & SUPPORT</h3>
      </div>
      <div class="menu-section-group" style="margin-top: 20px;">
        <div class="menu-list-section">
          <div class="menu-item" onclick="showMsg('FAQ articles coming soon.')">
            <div style="display:flex;
                            align-items:center;"><span class="menu-item-icon-container"><i
                  class="fas fa-question-circle"></i></span> FAQ</div>
            <div style="font-size:18px; color:var(--text-light);"><i class="fas fa-chevron-right"></i></div>
          </div>
          <div class="menu-item" onclick="navigateTo('profile')">
            <div style="display:flex;
                            align-items:center;"><span class="menu-item-icon-container"><i
                  class="fas fa-comments"></i></span> Contact us (Goes to profile contact link)</div>
            <div style="font-size:18px;
                            color:var(--text-light);"><i class="fas fa-chevron-right"></i></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div id="bottomNav" class="bottom-nav" style="display: flex; justify-content: space-around; align-items: center; position: fixed;
        bottom: 0; left: 50%; transform: translateX(-50%); max-width: 400px; width: 100%; height: 60px;
        z-index: 5;">
    <div class="nav-item active" data-page="calculator" onclick="navigateTo('calculator')">
      <div class="nav-icon"><i class="fas fa-home"></i></div>
    </div>
    <div class="nav-item" data-page="history" onclick="navigateTo('history')">
      <div class="nav-icon"><i class="fas fa-chart-bar"></i></div>
    </div>
    <div style="width: 60px;
            height: 60px; position: relative;">
      <div class="power-btn-container"
        onclick="showMsg('This would toggle a main device on/off or launch a control panel.')">
        <div class="power-btn-icon"><i class="fas fa-power-off"></i></div>
      </div>
    </div>
    <div class="nav-item" data-page="energy" onclick="navigateTo('energy')">
      <div class="nav-icon"><i class="fas fa-cog"></i></div>
    </div>
    <div class="nav-item" data-page="profile" onclick="navigateTo('profile')">
      <div class="nav-icon"><i class="fas fa-user"></i></div>
    </div>
  </div>

  <div id="editProfileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h4>Edit Profile</h4>
        <span class="close-btn" onclick="closeModal('editProfileModal')">&times;</span>
      </div>
      <div class="profile-pic-container" style="margin-bottom: 20px;">
        <div class="profile-pic" id="profilePicModal">
          <span id="defaultAvatarIconModal"><i class="fas fa-user"></i></span>
          <img id="profilePicImgModal" src="" style="display:none;" />
        </div>
        <button class="btn btn-secondary" style="width: auto;
                    padding: 8px 15px; margin-top: 10px; font-size: 14px;"
          onclick="document.getElementById('avatarInput').click()">Change Picture</button>
      </div>
      <div class="input-group"><input id="editUsername" type="text" class="input-field" placeholder="Username"></div>
      <div class="input-group"><input id="editEmail" type="email" class="input-field" placeholder="Email" disabled>
      </div>
      <div class="input-group"><input id="editPhone" type="text" class="input-field" placeholder="Phone Number"></div>
      <button id="saveProfileBtn" class="btn">Save Changes</button>
    </div>
  </div>

  <div id="changePasswordModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h4>Change Password</h4>
        <span class="close-btn" onclick="closeModal('changePasswordModal')">&times;</span>
      </div>
      <div class="input-group"><input id="currentPassword" type="password" class="input-field"
          placeholder="Current Password"></div>
      <div class="input-group"><input id="newPassword" type="password" class="input-field" placeholder="New Password">
      </div>
      <button class="btn" onclick="showMsg('Password change feature coming soon.')">Update Password</button>
    </div>
  </div>

  <div id="themeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h4>Select Theme</h4>
        <span class="close-btn" onclick="closeModal('themeModal')">&times;</span>
      </div>
      <div class="theme-option active" data-theme="dark" onclick="setTheme('dark')">Dark Theme (Default)</div>
      <div class="theme-option" data-theme="light" onclick="setTheme('light')">Light Theme (Coming Soon)</div>
    </div>
  </div>

  <div id="addApplianceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h4>Add New Appliance</h4>
        <span class="close-btn" onclick="closeModal('addApplianceModal')">&times;</span>
      </div>
      <div class="form-row">
        <input id="newDeviceName" type="text" class="input-field" placeholder="Device Name (e.g. Fan)">
        <input id="newDeviceWatt" type="number" class="input-field" placeholder="Watts" style="width: 80px;">
      </div>
      <div class="input-group">
        <div class="image-upload-container" onclick="document.getElementById('newDeviceImage').click()">
          <i class="fas fa-camera"></i>
          <span id="imageFileName">Upload Device Image (Optional)</span>
        </div>
        <input id="newDeviceImage" type="file" accept="image/*" style="display:none;"
          onchange="updateImageFileName(this)">
      </div>
      <button onclick="addNewAppliance(); closeModal('addApplianceModal')" class="btn">Add Device</button>
    </div>
  </div>

  <div id="selectApplianceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h4>Select Appliances</h4>
        <span class="close-btn" onclick="closeModal('selectApplianceModal'); updateSelectionSummary()">&times;</span>
      </div>
      <button id="selectAllAppliancesBtn" class="btn btn-secondary" style="padding: 8px 15px; margin-bottom: 10px;"
        onclick="selectAllAppliances()">Select All</button>

      <div id="applianceSelectionList" class="selection-list">
      </div>
      <button class="btn" onclick="closeModal('selectApplianceModal')">Done</button>
    </div>
  </div>

  <div
    style="position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); text-align: center; font-size: 10px; color: #555; max-width: 400px; width: 100%;">
    <p>Mock App UI | Updated: Dec 2025</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    // CONFIG
    const SUPABASE_URL = 'https://hsmbbiltunetxelxzxqq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzbWJiaWx0dW5ldHhlbHh6eHFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTM4NDMsImV4cCI6MjA4MDYyOTg0M30.n-b_AY2varvWTSOc8MBRwFytvFYmjCgat72V07E3n5E';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUser = null;
    let profileData = null;
    let currentChartView = 'month';
    // NEW GLOBAL ARRAY TO STORE SELECTED APPLIANCE IDs/DATA FOR CALCULATION
    let selectedAppliances = [];


    // UTILS
    function showMsg(msg) {
      alert(msg);
      console.log(msg);
    }
    function openModal(id) {
      document.getElementById(id).style.display = 'flex';
      if (id === 'selectApplianceModal') {
        generateApplianceSelectionModal();
      }
    }
    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }
    function navigateTo(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');

      // Update Mobile Nav
      document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === pageId) item.classList.add('active');
      });
      // Update Desktop Nav
      document.querySelectorAll('.desktop-nav-links a').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === pageId) item.classList.add('active');
        else item.style.color = 'var(--text-muted)';
      });
      const activeDesktopNav = document.querySelector('.desktop-nav-links a.active');
      if (activeDesktopNav) activeDesktopNav.style.color = 'var(--text-light)';

      // Adjust container display for auth vs app pages
      const container = document.querySelector('.container');
      const isAuthPage = ['welcome', 'login', 'signup'].includes(pageId);
      if (window.innerWidth >= 768) {
        if (isAuthPage) {
          container.style.display = 'block';
        } else {
          container.style.display = 'flex';
        }
      } else {
        container.style.display = 'block';
      }

      // Re-load history with current view if navigating to history
      if (pageId === 'history') {
        loadHistory();
      }
      // Load appliances if navigating to energy
      if (pageId === 'energy') {
        loadAppliances();
      }
    }
    function handleNavClick(pageId) {
      navigateTo(pageId);
    }

    // NEW: Helper function to get week number (ISO standard)
    function getWeekNumber(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      // Set to nearest Thursday: current date + 4 - current day number
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
      // Get first day of year
      var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      // Calculate full weeks to nearest Thursday
      var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return d.getUTCFullYear() + '-' + weekNo.toString().padStart(2, '0');
    }

    // AUTH
    async function initAuth() {
      const { data } = await supabaseClient.auth.getSession();
      currentUser = data?.session?.user || null;
      if (currentUser) {
        document.getElementById('bottomNav').style.display = window.innerWidth <= 768 ? 'flex' : 'none';
        document.getElementById('desktopHeader').style.display = window.innerWidth <= 768 ?
          'none' : 'block';
        document.getElementById('desktopProfileArea').style.display = 'flex';
        navigateTo('calculator');
        loadProfile();
        loadHistory(); // Load history after user is known
        loadAppliances(); // Load appliances after user is known
        updateSelectionSummary(); // Initialize calculator summary
      } else {
        document.getElementById('bottomNav').style.display = 'none';
        document.getElementById('desktopHeader').style.display = 'none';
        navigateTo('welcome');
      }
    }
    async function signup() {
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const username = document.getElementById('signupUsername').value;
      const phone = document.getElementById('signupPhone').value;

      if (!email || !password || !username) return showMsg("Please fill in email, password, and username.");

      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          data: { username, phone }
        }
      });

      if (error) showMsg('Signup failed: ' + error.message);
      else showMsg('Signup successful! Please check your email for confirmation.');
    }
    async function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) return showMsg("Please enter email and password.");

      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

      if (error) showMsg('Login failed: ' + error.message);
      else {
        currentUser = data.user;
        initAuth();
      }
    }
    async function logout() {
      const { error } = await supabaseClient.auth.signOut();
      if (error) showMsg('Logout failed: ' + error.message);
      else {
        currentUser = null;
        initAuth();
      }
    }
    function setTheme(theme) {
      if (theme !== 'dark') return showMsg('Only Dark Theme is available in this demo.');
      document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
      document.querySelector(`.theme-option[data-theme="${theme}"]`).classList.add('active');
      document.getElementById('currentTheme').innerText = theme.charAt(0).toUpperCase() + theme.slice(1);
    }

    // FEATURES
    function toggleCustomRateInput() {
      const connSelect = document.getElementById('connSelect');
      const customRateGroup = document.getElementById('customRateGroup');
      if (connSelect.value === 'custom') {
        customRateGroup.style.display = 'block';
      } else {
        customRateGroup.style.display = 'none';
      }
    }

    // UPDATED: calculateBill now uses selectedAppliances and dailyHoursInput
    async function calculateBill() {
      if (!currentUser) return showMsg('Please login');

      const totalWatts = updateSelectionSummary();
      const dailyHours = document.getElementById('dailyHoursInput').value;

      if (selectedAppliances.length === 0) return showMsg('Please select at least one appliance for the estimate.');
      if (!dailyHours || isNaN(dailyHours) || parseFloat(dailyHours) <= 0) return showMsg('Please enter a valid number of daily usage hours.');

      // 1. Calculate Monthly kWh
      // kWh = (Total Watts * Hours per Day * Days per Month) / 1000
      const daysInMonth = 30; // Using an average month for estimation
      const units = (totalWatts * parseFloat(dailyHours) * daysInMonth) / 1000;

      // 2. Determine Rate (Keep existing rate logic)
      const conn = document.getElementById('connSelect').value;
      let rate;
      let connDisplay;
      if (conn === 'residential') {
        rate = 12.00;
        connDisplay = 'Residential (‚Ç±12.00)';
      } else if (conn === 'commercial') {
        rate = 16.00;
        connDisplay = 'Commercial (‚Ç±16.00)';
      } else if (conn === 'custom') {
        const customRateInput = document.getElementById('customRateInput').value;
        if (!customRateInput || isNaN(customRateInput) || parseFloat(customRateInput) <= 0) {
          return showMsg('Please enter a valid custom rate (‚Ç±/kWh).');
        }
        rate = parseFloat(customRateInput);
        connDisplay = `Custom (‚Ç±${rate.toFixed(2)})`;
      } else {
        rate = 12.00;
        connDisplay = 'Residential (‚Ç±12.00)';
      }

      // 3. Calculate Bill Amount
      const amount = (units * rate).toFixed(2);

      // 4. Store Bill (Note: The `units` column in `bills` table stores kWh)
      const { error } = await supabaseClient.from('bills').insert([
        // units: kWh calculated from appliances
        { user_id: currentUser.id, units: units.toFixed(2), connection: connDisplay, amount }
      ]);

      if (error) showMsg(error.message);
      else {
        showMsg(`Bill Estimate Saved: ‚Ç±${amount} for ${units.toFixed(2)} kWh`);
        document.getElementById('calcDisplayKwh').innerText = units.toFixed(0);
        document.getElementById('calcDisplayKwh2').innerText = units.toFixed(0);
        loadHistory();
      }
    }

    // NEW: Function to generate the chart dynamically
    function generateChart(bills, view = 'month') {
      const chartArea = document.getElementById('chartArea');
      // Keep the title
      let chartHTML = '<h3>Consumption (KWh)</h3>';

      const groupedData = {};
      const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

      bills.forEach(bill => {
        const date = new Date(bill.created_at);
        let key, label;

        if (view === 'month') {
          // Group by Year-Month
          key = `${date.getFullYear()}-${date.getMonth().toString().padStart(2, '0')}`; // e.g., 2025-11
          label = monthNames[date.getMonth()];
        } else if (view === 'year') {
          // Group by Year
          key = date.getFullYear().toString();
          label = key;
        } else if (view === 'week') {
          // Group by Year-WeekNumber
          key = getWeekNumber(date); // e.g., '2025-51'
          label = 'Wk ' + key.split('-')[1];
        }

        if (!groupedData[key]) {
          groupedData[key] = {
            label: label,
            units: 0
          };
        }
        // Ensure units are treated as a number
        groupedData[key].units += parseFloat(bill.units);
      });

      // Convert object to array and sort by key (Date/Key)
      let chartBars = Object.keys(groupedData).sort().map(key => groupedData[key]);

      // Limit the data shown based on the view
      if (view === 'month') {
        chartBars = chartBars.slice(-6); // Last 6 months
      } else if (view === 'week') {
        chartBars = chartBars.slice(-8); // Last 8 weeks
      }
      // For 'year', we show all available years

      if (chartBars.length === 0) {
        chartArea.innerHTML = chartHTML + '<p style="text-align:center; color:var(--text-muted); margin-top: 50px;">No bill data available for this period.</p>';
        return;
      }

      // Find the max consumption to normalize the bar heights
      const maxUnits = Math.max(...chartBars.map(d => d.units));

      chartBars.forEach(data => {
        // Calculate height as a percentage of the max consumption, using a max of 90%
        const heightPercent = (data.units / maxUnits) * 90;

        chartHTML += `
                    <div class="bar-container" title="${data.label}: ${data.units.toFixed(0)} KWh">
                        <div class="bar" style="height: ${heightPercent.toFixed(0)}%;"></div>
                        <div class="bar-label">${data.label}</div>
                    </div>
                `;
      });

      chartArea.innerHTML = chartHTML;
    }

    // NEW: Function to handle chart view switch
    function updateChartView(view) {
      currentChartView = view;
      // Update button styles
      document.querySelectorAll('.chart-header-button').forEach(btn => {
        btn.style.background = 'var(--bg-dark)';
        btn.style.color = 'var(--text-light)';
      });
      document.getElementById(`chartBtn${view.charAt(0).toUpperCase() + view.slice(1)}`).style.background = 'var(--accent-teal)';
      document.getElementById(`chartBtn${view.charAt(0).toUpperCase() + view.slice(1)}`).style.color = 'var(--bg-dark)';

      loadHistory();
    }


    async function loadHistory() {
      if (!currentUser) return;

      // Fetch all data for accurate grouping/sorting, sorting ascending for chronological order
      const { data: bills, error } = await supabaseClient.from('bills')
        .select('*').eq('user_id', currentUser.id).order('created_at', { ascending: true });

      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = '';

      if (bills && bills.length > 0) {
        // 1. Update the graph with the current view
        generateChart(bills, currentChartView);

        // 2. Update the table (using only the last 5 for the table display)
        // Need to re-sort descending for the table display
        const recentBills = [...bills].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5);

        // Update the main Kwh display on the home screen
        document.getElementById('calcDisplayKwh').innerText = parseFloat(recentBills[0].units).toFixed(0);
        document.getElementById('calcDisplayKwh2').innerText = parseFloat(recentBills[0].units).toFixed(0);

        recentBills.forEach(bill => {
          const date = new Date(bill.created_at).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

          // The connection column now stores the descriptive rate (e.g., "Custom (‚Ç±14.50)")
          const connTypeDisplay = bill.connection;
          const rateKwh = `${parseFloat(bill.units).toFixed(0)} / ${connTypeDisplay}`;

          tbody.innerHTML += `<tr><td>${date}</td><td>${rateKwh}</td><td>‚Ç±${parseFloat(bill.amount).toFixed(2)}</td></tr>`;
        });
      } else {
        // Sample data when no history exists - UPDATED for Pesos
        tbody.innerHTML = `
                    <tr><td>Sept. 2025</td><td>320 / Residential (‚Ç±12.00)</td><td>‚Ç±3,840.00</td></tr>
                    <tr><td>Oct. 2025</td><td>200 / Residential (‚Ç±12.00)</td><td>‚Ç±2,400.00</td></tr>
                    <tr><td>Nov. 2025</td><td>240 / Commercial (‚Ç±16.00)</td><td>‚Ç±3,840.00</td></tr>
                `;
        // Also update chart area with a message
        document.getElementById('chartArea').innerHTML = '<h3>Consumption (KWh)</h3><p style="text-align:center; color:var(--text-muted); margin-top: 50px;">No bill data available.</p>';
      }
    }

    // --- NEW APPLIANCE LOGIC (Supabase Integration) ---

    // Helper to update file name display
    function updateImageFileName(input) {
      const fileNameSpan = document.getElementById('imageFileName');
      if (input.files && input.files.length > 0) {
        fileNameSpan.innerText = input.files[0].name;
        fileNameSpan.style.color = 'var(--text-light)';
      } else {
        fileNameSpan.innerText = 'Upload Device Image (Optional)';
        fileNameSpan.style.color = 'var(--text-muted)';
      }
    }

    async function loadAppliances() {
      if (!currentUser) return;

      const { data: appliances, error } = await supabaseClient
        .from('appliances')
        .select('id, name, units, image_url')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false });

      const grid = document.getElementById('dynamicApplianceGrid');
      if (!grid) return;
      grid.innerHTML = '';

      if (error) {
        showMsg("Error loading appliances: " + error.message);
        return;
      }

      appliances.forEach(app => {
        // 'units' column is used for wattage
        const watts = parseFloat(app.units).toFixed(0);

        let iconContent;
        if (app.image_url) {
          iconContent = `<img src="${app.image_url}" alt="${app.name}">`;
        } else {
          // Default icon if no image
          iconContent = `<i class="fas fa-plug" style="color: var(--accent-teal);"></i>`;
        }

        grid.innerHTML += `
                    <div class="appliance-card" data-id="${app.id}">
                        <div class="delete-btn" onclick="removeAppliance(${app.id})"><i class="fas fa-times"></i></div>
                        <div class="appliance-icon">${iconContent}</div>
                        <div class="appliance-name">${app.name}</div>
                        <div class="appliance-power">${watts}W</div>
                    </div>
                `;
      });
      // Also update the selection modal list if it was open or being used for calculation
      generateApplianceSelectionModal();
    }

    async function addNewAppliance() {
      if (!currentUser) return showMsg('Please login to add appliances.');

      const name = document.getElementById('newDeviceName').value.trim();
      const watts = document.getElementById('newDeviceWatt').value;
      const imageFile = document.getElementById('newDeviceImage').files[0];

      if (!name || !watts || isNaN(watts) || parseFloat(watts) <= 0) {
        return showMsg("Please enter a valid device name and wattage (in Watts).");
      }

      let image_url = null;

      if (imageFile) {
        // 1. Upload image to Supabase Storage
        const fileExt = imageFile.name.split('.').pop();
        const fileName = `${currentUser.id}/${Date.now()}_${name.replace(/\s/g, '_')}.${fileExt}`;

        const { error: uploadError } = await supabaseClient.storage
          .from('appliance_images') // Assumes you have a bucket named appliance_images
          .upload(fileName, imageFile);

        if (uploadError) {
          return showMsg('Image upload failed: ' + uploadError.message);
        }

        // 2. Get Public URL
        const { data: { publicUrl } } = supabaseClient.storage.from('appliance_images').getPublicUrl(fileName);
        image_url = publicUrl;
      }

      // 3. Insert appliance data into the public.appliances table
      const { error } = await supabaseClient.from('appliances').insert([
        {
          user_id: currentUser.id,
          name: name,
          units: parseFloat(watts), // Storing watts in the 'units' column
          image_url: image_url     // Storing image URL
        }
      ]);

      if (error) {
        showMsg('Failed to add appliance: ' + error.message);
      } else {
        showMsg('Appliance added successfully!');
        // Clear inputs and reload list
        document.getElementById('newDeviceName').value = '';
        document.getElementById('newDeviceWatt').value = '';
        document.getElementById('newDeviceImage').value = '';
        updateImageFileName(document.getElementById('newDeviceImage'));
        loadAppliances();
      }
    }

    async function removeAppliance(applianceId) {
      if (!currentUser) return;
      if (!confirm("Remove this appliance? This action cannot be undone.")) return;

      const { error } = await supabaseClient.from('appliances').delete().eq('id', applianceId);

      if (error) {
        showMsg('Failed to remove appliance: ' + error.message);
      } else {
        showMsg('Appliance removed successfully!');
        // Remove from local selection list if present
        selectedAppliances = selectedAppliances.filter(app => app.id !== applianceId);
        updateSelectionSummary();
        loadAppliances();
      }
    }

    // --- NEW APPLIANCE SELECTION/CALCULATION LOGIC ---

    // Called when opening the 'Select Appliances' modal
    async function generateApplianceSelectionModal() {
      if (!currentUser) return;

      const { data: appliances, error } = await supabaseClient
        .from('appliances')
        .select('id, name, units, image_url')
        .eq('user_id', currentUser.id)
        .order('name', { ascending: true });

      const list = document.getElementById('applianceSelectionList');
      if (!list) return;
      list.innerHTML = '';

      if (error) {
        list.innerHTML = `<p style="color:var(--text-muted); text-align:center; padding: 20px;">Error loading appliances.</p>`;
        return;
      }

      if (appliances.length === 0) {
        list.innerHTML = `<p style="color:var(--text-muted); text-align:center; padding: 20px;">No appliances added yet. Add one first!</p>`;
        document.getElementById('selectAllAppliancesBtn').disabled = true;
        return;
      }
      document.getElementById('selectAllAppliancesBtn').disabled = false;

      appliances.forEach(app => {
        // Check if the appliance is already in the global 'selectedAppliances' array
        const isSelected = selectedAppliances.some(s => s.id === app.id);

        list.innerHTML += `
                    <div class="selection-item" onclick="toggleApplianceSelection(${app.id}, '${app.name.replace(/'/g, "\\'")}', ${app.units}, this)">
                        <div class="selection-item-info">
                            <input type="checkbox" class="appliance-selection-checkbox" 
                                data-id="${app.id}" data-name="${app.name}" data-watts="${app.units}" ${isSelected ? 'checked' : ''} onchange="event.stopPropagation()">
                            <span>${app.name}</span>
                        </div>
                        <div style="font-size:12px; color:var(--text-muted);">
                            <strong>${parseFloat(app.units).toFixed(0)}W</strong>
                        </div>
                    </div>
                `;
      });
      updateSelectionSummary();
    }

    // Handle individual selection click (including the row)
    function toggleApplianceSelection(id, name, watts, element) {
      const checkbox = element.querySelector('.appliance-selection-checkbox');
      // Toggle the checkbox state
      const newState = !checkbox.checked;
      checkbox.checked = newState;

      // Update the global selection array
      const appId = parseInt(id);
      if (newState) {
        // Only push if not already present (prevents duplicates if selection array wasn't reset)
        if (!selectedAppliances.some(app => app.id === appId)) {
          selectedAppliances.push({ id: appId, name, watts: parseFloat(watts) });
        }
      } else {
        selectedAppliances = selectedAppliances.filter(app => app.id !== appId);
      }

      updateSelectionSummary();
    }

    // Handle "Select All" button click
    function selectAllAppliances() {
      const checkboxes = document.querySelectorAll('#applianceSelectionList .appliance-selection-checkbox');
      selectedAppliances = []; // Reset array
      checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        selectedAppliances.push({
          id: parseInt(checkbox.dataset.id),
          name: checkbox.dataset.name,
          watts: parseFloat(checkbox.dataset.watts)
        });
      });
      updateSelectionSummary();
    }

    // Updates the summary text on the Energy screen
    function updateSelectionSummary() {
      const totalWatts = selectedAppliances.reduce((sum, app) => sum + app.watts, 0);
      const count = selectedAppliances.length;

      const summary = document.getElementById('selectedApplianceSummary');
      if (summary) {
        summary.innerHTML = `${count} appliance${count !== 1 ? 's' : ''} selected. Total Wattage: <strong>${totalWatts.toFixed(0)}W</strong>`;
      }
      return totalWatts;
    }

    // --- PROFILE LOGIC ---
    function updateProfileUI(data) {
      profileData = data;
      const username = data.username || currentUser.email.split('@')[0];

      // Update inputs in modal
      document.getElementById('editUsername').value = username;
      document.getElementById('editEmail').value = currentUser.email;
      document.getElementById('editPhone').value = data.phone || '';

      // Update displays
      document.getElementById('profileName').innerText = username;
      document.getElementById('desktopProfileName').innerText = username;
      document.getElementById('mobileHomeUsername').innerText = username;

      // Update avatar images/icons
      [
        { img: document.getElementById('profilePicImg'), icon: document.getElementById('defaultAvatarIcon') },
        { img: document.getElementById('desktopProfilePicImg'), icon: document.getElementById('desktopDefaultAvatarIcon') },
        { img: document.getElementById('mobileProfilePicImgHome'), icon: document.getElementById('mobileDefaultAvatarIconHome') },
        { img: document.getElementById('profilePicImgModal'), icon: document.getElementById('defaultAvatarIconModal') }
      ].forEach(({ img, icon }) => {
        if (img && icon) {
          if (data.avatar_url) {
            img.src = data.avatar_url;
            img.style.display = 'block';
            icon.style.display = 'none';
          } else {
            img.style.display = 'none';
            icon.style.display = 'block';
          }
        }
      });
    }
    async function loadProfile() {
      if (!currentUser) return;
      const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
      if (data) {
        profileData = data;
        updateProfileUI(data);
        // Also load appliance data when profile is ready
        loadAppliances();
      }
    }
    async function saveProfile() {
      if (!currentUser) return;
      const username = document.getElementById('editUsername').value;
      const phone = document.getElementById('editPhone').value;

      const updates = { id: currentUser.id, username, phone, email: currentUser.email };

      // Check for avatar upload
      const fileInput = document.getElementById('avatarInput');
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;

        // 1. Upload to 'avatars' bucket
        const { error: uploadError } = await supabaseClient.storage.from('avatars').upload(fileName, file);
        if (uploadError) {
          return showMsg('Image upload failed: ' + uploadError.message);
        }
        // 2. Get Public URL
        const { data: { publicUrl } } = supabaseClient.storage.from('avatars').getPublicUrl(fileName);
        updates.avatar_url = publicUrl;
      }

      // 3. Update Table
      const { data: updatedData, error } = await supabaseClient.from('profiles').upsert(updates).select();

      if (error) showMsg('Profile update failed: ' + error.message);
      else {
        updateProfileUI(updatedData[0]);
        closeModal('editProfileModal');
        showMsg('Profile updated successfully!');
      }
    }

    // EVENT LISTENERS
    document.addEventListener('DOMContentLoaded', () => {
      initAuth();

      document.getElementById('calcBtn').addEventListener('click', calculateBill);
      document.getElementById('signupBtn').addEventListener('click', signup);
      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);

      // Initial navigation
      navigateTo(currentUser ? 'calculator' : 'welcome');
      window.addEventListener('resize', handleResize);

    });

    // Handle window resize for mobile/desktop nav
    function handleResize() {
      if (currentUser) {
        const isMobile = window.innerWidth <= 768;
        document.getElementById('bottomNav').style.display = isMobile ? 'flex' : 'none';
        document.getElementById('desktopHeader').style.display = isMobile ? 'none' : 'block';
        const currentPage = document.querySelector('.page.active').id;
        const container = document.querySelector('.container');
        const isAuthPage = ['welcome', 'login', 'signup'].includes(currentPage);
        if (!isMobile) {
          if (isAuthPage) {
            container.style.display = 'block';
          } else {
            container.style.display = 'flex';
          }
        } else {
          container.style.display = 'block';
        }
      }
    }

  </script>
</body>

</html>